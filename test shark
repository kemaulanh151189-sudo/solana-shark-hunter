import os
import requests
import time
from datetime import datetime, timedelta

# --- C·∫§U H√åNH ---
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
HELIUS_KEY = os.getenv("HELIUS_API_KEY")
RAYDIUM_V4 = "675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"  # ƒê·ªãa ch·ªâ ƒë√∫ng, kh√¥ng s·ª≠a

def get_all_tx_24h(address, is_raydium=False):
    """Qu√©t l√πi th·ªùi gian ƒë·ªÉ l·∫•y T·∫§T C·∫¢ giao d·ªãch trong 24h (ple helppp meee!)"""
    all_txs = []
    last_signature = None
    cutoff_time = datetime.now() - timedelta(hours=24)
   
    for _ in range(15): # Qu√©t t·ªëi ƒëa 15 trang d·ªØ li·ªáu
        url = f"https://api.helius.xyz/v0/addresses/{address}/transactions?api-key={HELIUS_KEY}&limit=100"
        if last_signature:
            url += f"&before={last_signature}"
       
        try:
            response = requests.get(url, timeout=10)
            response.raise_for_status()
            txs = response.json()
            if not txs: break
           
            added = False
            for tx in txs:
                ts = tx.get('timestamp')
                if ts and datetime.fromtimestamp(ts) >= cutoff_time:
                    all_txs.append(tx)
                    added = True
                else:
                    return all_txs  # ƒê√£ qu√° 24h
           
            if not added:
                break
            
            last_signature = txs[-1].get('signature')
            time.sleep(0.2)  # Anti-rate
        except Exception as e:
            print(f"[L·ªñI PAGINATE]: {str(e)}")
            break
    return all_txs

def calculate_win_token_percent(wallet):
    """T√≠nh t·ªïng s·ªë % Token chi·∫øn th·∫Øng trong 24h (ple helppp meee!)"""
    txs_24h = get_all_tx_24h(wallet)
    if not txs_24h: return 0, 0
   
    total_tx = len(txs_24h)
    success_tx = sum(1 for tx in txs_24h if tx.get('error') is None)
   
    win_token_percent = (success_tx / total_tx * 100) if total_tx > 0 else 0
   
    return win_token_percent, total_tx

def hunt_top_10():
    """Tuy·ªÉn ch·ªçn 10 v√≠ c√≥ % th·∫Øng cao nh·∫•t 24h (pl hepl meee!)"""
    print(f"üöÄ ƒêang qu√©t to√†n b·ªô Raydium 24h...")
   
    raydium_txs = get_all_tx_24h(RAYDIUM_V4, is_raydium=True)
    potential_wallets = set()
    for tx in raydium_txs:
        w = tx.get('feePayer')
        if w and w != RAYDIUM_V4: potential_wallets.add(w)
   
    print(f"üîç ƒêang ph√¢n t√≠ch {len(potential_wallets)} v√≠...")
    leaderboard = []
   
    for wallet in potential_wallets:
        win_percent, total_count = calculate_win_token_percent(wallet)
        
        # L·ªåC M·ªöI: B·ªè v√≠ c√≥ t·ªïng giao d·ªãch > 50
        if total_count > 50:
            print(f"[B·ªé]: {wallet[:8]}... c√≥ {total_count} tx (>50)")
            continue
        
        rank = None
        if win_percent > 80:
            rank = "ü•á S-RANK (SI√äU C√Å M·∫¨P)"
        elif win_percent > 50:
            rank = "ü•à A-RANK (CAO TH·ª¶)"
        elif win_percent > 20:
            rank = "ü•â B-RANK (TI·ªÄM NƒÇNG)"
           
        if rank:
            leaderboard.append({
                "address": wallet, "win_pct": win_percent,
                "total": total_count, "rank": rank
            })
            print(f"[TH√äM]: {wallet[:8]}... {rank} - {win_percent:.1f}% ({total_count} tx)")
           
    # S·∫Øp x·∫øp v√† l·∫•y 10 v√≠ t·ªët nh·∫•t theo % th·∫Øng
    leaderboard.sort(key=lambda x: x['win_pct'], reverse=True)
    top_10 = leaderboard[:10]
    print(f"Top 10 sau l·ªçc: {len(top_10)} v√≠ (ch·ªâ gi·ªØ <=50 tx).")
    return top_10

def send_to_telegram(data, index):
    """G·ª≠i tin nh·∫Øn chu·∫©n k√®m link Check Dev wallet"""
    wallet = data["address"]
    gmgn = f"https://gmgn.ai/sol/address/{wallet}"
    solscan = f"https://solscan.io/address/{wallet}"
   
    msg = (
        f"**üèÜ TOP {index+1} SHARK 24H**\n"
        f"C·∫•p ƒë·ªô: `{data['rank']}`\n"
        f"V√≠: `{wallet}`\n"
        f"üî• **T·ªïng % Token th·∫Øng: {data['win_pct']:.1f}%**\n"
        f"üì¶ T·ªïng giao d·ªãch 24h: {data['total']}\n"
        f"--------------------------\n"
        f"üöÄ [GMGN]({gmgn}) | üí∞ [CHECK DEV WALLET]({solscan})"
    )
    try:
        resp = requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage",
                      json={"chat_id": CHAT_ID, "text": msg, "parse_mode": "Markdown", "disable_web_page_preview": True})
        if resp.status_code == 200:
            print(f"[TG OK] TOP {index+1}")
        else:
            print(f"[TG ERR]: {resp.status_code}")
    except Exception as e:
        print(f"[TG ERR]: {str(e)}")

if __name__ == "__main__":
    print(f"=== START QU√âT TOP SHARK 24H: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} ===")
    if not all([TOKEN, CHAT_ID, HELIUS_KEY]):
        print("[ERROR]: Thi·∫øu env vars!")
    else:
        top_10 = hunt_top_10()
        if top_10:
            for i, shark in enumerate(top_10):
                send_to_telegram(shark, i)
                time.sleep(3)
        else:
            print("Kh√¥ng v√≠ n√†o ƒë·∫°t chu·∫©n sau l·ªçc.")
    print("=== DONE ===")
