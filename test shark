import os
import requests
import time
from datetime import datetime, timedelta

# --- C·∫§U H√åNH H·ªÜ TH·ªêNG ---
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
HELIUS_KEY = os.getenv("HELIUS_API_KEY")

# ƒê·ªãa ch·ªâ Raydium AMM v4 ƒë√∫ng (Legacy AMM v4 Constant Product)
RAYDIUM_V4 = "675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"

def calculate_real_performance(wallet):
    """Soi l·ªãch s·ª≠ v√≠ trong 24h qua (ple helppp meee!)"""
    try:
        # L·∫•y t·ªëi ƒëa 100 tx
        url = f"https://api.helius.xyz/v0/addresses/{wallet}/transactions?api-key={HELIUS_KEY}&limit=100"
        response = requests.get(url, timeout=10)
        response.raise_for_status()  # Raise n·∫øu l·ªói HTTP
        txs = response.json()
        if not txs:
            return 0, 0
        
        # Ch·ªâ ƒë·∫øm tx trong v√≤ng 24h qua
        now = datetime.now()
        txs_24h = []
        for tx in txs:
            ts = tx.get('timestamp')
            if ts and (now - datetime.fromtimestamp(ts)).total_seconds() < 86400:
                txs_24h.append(tx)
        
        if not txs_24h:
            return 0, 0
        
        total_tx = len(txs_24h)
        success_tx = sum(1 for tx in txs_24h if tx.get('error') is None)
        win_rate = (success_tx / total_tx * 100) if total_tx > 0 else 0
        
        # ROI proxy: win_rate * 3 ƒë·ªÉ d·ªÖ pass filter test th·∫•p (sau n√†y parse net change th·∫≠t)
        avg_roi = win_rate * 3
        
        return win_rate, avg_roi
    except Exception as e:
        print(f"[L·ªñI CALC {wallet[:8]}...]: {str(e)}")
        return 0, 0

def brain_check_rank(wr, roi):
    """Gi·ªØ nguy√™n 3 c·∫•p ƒë·ªô l·ªçc c·ªßa b·∫°n (ple helppp meee!)"""
    if wr > 3 and roi > 5:
        return "ü•á HUY·ªÄN THO·∫†I (S-RANK 24H)", "CAO NH·∫§T"
    elif wr > 2 and roi > 2:
        return "ü•à CAO TH·ª¶ (A-RANK 24H)", "TRUNG B√åNH"
    elif wr > 1 and roi > 1:
        return "ü•â T√ÇN BINH PRO (B-RANK 24H)", "TH·∫§P"
    return None, None

def get_24h_sharks():
    """Qu√©t di·ªán r·ªông Raydium ƒë·ªÉ t√¨m Shark 24h (ple helppp meee!)"""
    url = f"https://api.helius.xyz/v0/addresses/{RAYDIUM_V4}/transactions?api-key={HELIUS_KEY}&limit=100"
    
    try:
        response = requests.get(url, timeout=15)
        response.raise_for_status()
        txs = response.json()
        
        found_wallets = []
        processed = set()
        
        for tx in txs:
            user_wallet = tx.get('feePayer')  # Fee payer th∆∞·ªùng l√† user kh·ªüi t·∫°o tx
            
            # Fallback n·∫øu kh√¥ng c√≥ feePayer
            if not user_wallet and tx.get('accountData'):
                account_data = tx.get('accountData', [])
                if account_data:
                    user_wallet = account_data[0].get('account')
            
            if (user_wallet and 
                user_wallet != RAYDIUM_V4 and 
                len(user_wallet) == 44 and  # Base58 Solana address length
                user_wallet not in processed):
                
                processed.add(user_wallet)
                
                wr, roi = calculate_real_performance(user_wallet)
                
                rank_name, priority = brain_check_rank(wr, roi)
                if rank_name:
                    found_wallets.append({
                        "address": user_wallet,
                        "winrate": wr,
                        "roi": roi,
                        "rank": rank_name,
                        "priority": priority
                    })
                    print(f"[PH√ä DUY·ªÜT]: {user_wallet[:8]}... {rank_name}")
            
            if len(found_wallets) >= 5:
                break  # Top 5 v√≠ x·ªãn nh·∫•t
        
        print(f"T√¨m ƒë∆∞·ª£c {len(found_wallets)} v√≠ shark 24h.")
        return found_wallets
    except Exception as e:
        print(f"[L·ªñI QU√âT RAYDIUM]: {str(e)}")
        return []

def send_to_telegram(data):
    """Tin nh·∫Øn k√®m link Check Dev wallet"""
    wallet = data["address"]
    msg = (
        f"**üìä 24H SHARK REPORT: {data['rank']}**\n\n"
        f"**Address:** `{wallet}`\n"
        f"**Winrate 24h:** {data['winrate']:.1f}% | **ROI proxy:** {data['roi']:.1f}%\n"
        f"**M·ª©c ƒë·ªô ∆∞u ti√™n:** `{data['priority']}`\n"
        f"--------------------------\n"
        f"üöÄ [GMGN](https://gmgn.ai/sol/address/{wallet}) | üí∞ [CHECK DEV WALLET](https://solscan.io/address/{wallet})"
    )
    try:
        resp = requests.post(
            f"https://api.telegram.org/bot{TOKEN}/sendMessage",
            json={"chat_id": CHAT_ID, "text": msg, "parse_mode": "Markdown", "disable_web_page_preview": True}
        )
        if resp.status_code == 200:
            print(f"[TELEGRAM]: Sent {data['rank']} cho v√≠ {wallet[:8]}...")
        else:
            print(f"[TG ERR]: {resp.status_code} - {resp.text[:100]}")
    except Exception as e:
        print(f"[L·ªñI G·ª¨I TG]: {str(e)}")

if __name__ == "__main__":
    print(f"üöÄ ƒêang qu√©t to√†n b·ªô v√≠ 24h... {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    if not all([TOKEN, CHAT_ID, HELIUS_KEY]):
        print("[ERROR]: Thi·∫øu env vars (TOKEN/CHAT_ID/HELIUS)! Check GitHub Secrets.")
    else:
        sharks = get_24h_sharks()
        if sharks:
            for s in sharks:
                send_to_telegram(s)
                time.sleep(2)  # Anti-spam
        else:
            print("Kh√¥ng t√¨m th·∫•y v√≠ shark n√†o ƒë·∫°t chu·∫©n (c√≥ th·ªÉ do rate limit Helius ho·∫∑c kh√¥ng c√≥ tx ph√π h·ª£p).")
    print("Done.")
