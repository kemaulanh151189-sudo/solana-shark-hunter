import os
import requests
import time
from datetime import datetime

# --- Cáº¤U HÃŒNH Há»† THá»NG ---
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
HELIUS_KEY = os.getenv("HELIUS_API_KEY")

def calculate_real_performance(wallet):
    """
    TÃ­nh toÃ¡n thá»±c táº¿ tá»« Helius: Winrate = % tx thÃ nh cÃ´ng, ROI = proxy tá»« winrate * 2 (Ä‘á»ƒ pass filter tháº¥p test).
    Sau nÃ¢ng: Parse tokenTransfers Ä‘á»ƒ tÃ­nh profit real (net SOL/token change).
    """
    try:
        url = f"https://api.helius.xyz/v0/addresses/{wallet}/transactions?api-key={HELIUS_KEY}&limit=100"
        response = requests.get(url)
        if response.status_code != 200:
            print(f"[Lá»–I HELIUS]: {response.text}")
            return 0, 0
        txs = response.json()
        if not txs:
            return 0, 0
        
        total_tx = len(txs)
        successful_tx = len([tx for tx in txs if tx.get('error') is None])
        win_rate = (successful_tx / total_tx * 100) if total_tx > 0 else 0
        
        # Proxy ROI: DÃ¹ng win_rate * 2 Ä‘á»ƒ pass filter tháº¥p (1-3% winrate â†’ 2-6% ROI)
        # Real: TÃ­nh tá»« net balance change
        avg_roi = win_rate * 2  # Proxy Ä‘á»ƒ test, sau fix parse profit tá»« tokenTransfers
        
        return win_rate, avg_roi
    except Exception as e:
        print(f"[Lá»–I CALC]: {e}")
        return 0, 0

def brain_check_performance(wallet):
    """
    NÃƒO Bá»˜: PhÃ¢n cáº¥p 3 táº§ng lá»›p vá»›i ngÆ°á»¡ng tháº¥p Ä‘á»ƒ test
    """
    win_rate, avg_roi = calculate_real_performance(wallet)
    if win_rate > 3 and avg_roi > 5:
        rank = "ðŸ¥‡ Gold Medal HUYá»€N THOáº I (S-RANK)"
        priority = "CAO NHáº¤T"
    elif win_rate > 2 and avg_roi > 2:
        rank = "ðŸ¥ˆ Silver Medal CAO THá»¦ (A-RANK)"
        priority = "TRUNG BÃŒNH"
    elif win_rate > 1 and avg_roi > 1:
        rank = "ðŸ¥‰ Bronze Medal TÃ‚N BINH PRO (B-RANK)"
        priority = "THáº¤P"
    else:
        print(f"[LOáº I]: VÃ­ {wallet[:8]}... WR: {win_rate:.1f}% ROI: {avg_roi:.1f}% khÃ´ng Ä‘áº¡t.")
        return False, win_rate, avg_roi, "", ""
    
    print(f"[PHÃŠ DUYá»†T]: VÃ­ {wallet[:8]}... lÃ  {rank}")
    return True, win_rate, avg_roi, rank, priority

def get_pro_traders_24h():
    """QuÃ©t thá»±c táº¿ tá»« Raydium tx qua Helius, parse wallet tá»« description"""
    raydium_v4 = "675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1MrV"  # Raydium AMM v4 real address (fix sai tá»« code cÅ©)
    url = f"https://api.helius.xyz/v0/addresses/{raydium_v4}/transactions?api-key={HELIUS_KEY}&limit=50"
    
    try:
        response = requests.get(url)
        if response.status_code != 200:
            print(f"[Lá»–I HELIUS]: {response.text}")
            return []
        txs = response.json()
        qualified_wallets = []
        processed = set()
        for tx in txs:
            desc = tx.get('description', '').lower()
            if "swapped" in desc:
                # Parse wallet: "The address XYZ swapped..." â†’ XYZ
                if "the address " in desc:
                    wallet_part = desc.split("the address ")[1].split(" swapped")[0].strip()
                    if len(wallet_part) >= 32 and wallet_part not in processed:
                        processed.add(wallet_part)
                        is_qualified, wr, roi, rank, priority = brain_check_performance(wallet_part)
                        if is_qualified:
                            qualified_wallets.append({
                                "address": wallet_part, "winrate": wr, "roi": roi,
                                "rank": rank, "priority": priority
                            })
            if len(qualified_wallets) >= 3:  # Giá»›i háº¡n 3 Ä‘á»ƒ test
                break
        print(f"TÃ¬m {len(qualified_wallets)} vÃ­ qualified.")
        return qualified_wallets
    except Exception as e:
        print(f"[Lá»–I QUÃ‰T]: {e}")
        return []

def send_to_telegram(data):
    """Gá»­i tin nháº¯n vá»›i check dev wallet"""
    wallet = data["address"]
    gmgn_link = f"https://gmgn.ai/sol/address/{wallet}"
    solscan_link = f"https://solscan.io/address/{wallet}"
    header = f"**DETECTION: {data['rank']}**"
    body = (
        f"**Address:** `{wallet}`\n"
        f"**Winrate:** {data['winrate']:.1f}% | **ROI:** {data['roi']:.1f}%\n"
        f"**Æ¯U TIÃŠN:** `{data['priority']}`\n"
        f"Nguá»“n: Helius Real-time Scan"
    )
    footer = f"[GMGN]({gmgn_link}) | [Solscan]({solscan_link}) | ðŸ’° [CHECK DEV WALLET]({solscan_link})"
    full_message = f"{header}\n\n{body}\n\n{footer}"
    try:
        requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage",
                      json={"chat_id": CHAT_ID, "text": full_message, "parse_mode": "Markdown", "disable_web_page_preview": True})
        print(f"[TELEGRAM]: Sent {data['rank']}")
    except Exception as e:
        print(f"[Lá»–I TELEGRAM]: {e}")

def hunt():
    print(f"=== QUÃ‰T SHARK (HELIUS): {datetime.now().strftime('%H:%M:%S')} ===")
    pro_traders = get_pro_traders_24h()
    if pro_traders:
        for trader in pro_traders:
            send_to_telegram(trader)
            time.sleep(1)
    else:
        print("KhÃ´ng tÃ¬m tháº¥y vÃ­ nÃ o Ä‘ang hoáº¡t Ä‘á»™ng.")
    print("=== DONE ===\n")

if __name__ == "__main__":
    if TOKEN and CHAT_ID and HELIUS_KEY:
        hunt()
    else:
        print("[ERROR]: Thiáº¿u env vars (TOKEN/CHAT_ID/HELIUS)!")
