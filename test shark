import os
import requests
import time
from datetime import datetime, timezone

# --- Cáº¤U HÃŒNH TEST (ple helppp meee!) ---
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
HELIUS_KEY = os.getenv("HELIUS_API_KEY")

def brain_check_performance(wallet):
    """
    NÃƒO Bá»˜: PhÃ¢n cáº¥p 3 táº§ng - Háº  ÄIá»€U KIá»†N Cá»°C THáº¤P Äá»‚ TEST (pl hepl meee!)
    Cáº¥p 1 (ğŸ¥‡): Winrate >= 3%
    Cáº¥p 2 (ğŸ¥ˆ): Winrate >= 2%
    Cáº¥p 3 (ğŸ¥‰): Winrate >= 1%
    """
    try:
        # GIáº¢ Láº¬P: Bot sáº½ tá»± cho vÃ­ nÃ y cÃ³ Winrate 5% Ä‘á»ƒ cháº¯c cháº¯n khá»›p Cáº¥p 1
        # Báº¡n cÃ³ thá»ƒ sá»­a sá»‘ 5 nÃ y thÃ nh 2.5 Ä‘á»ƒ xem nÃ³ cÃ³ bÃ¡o thÃ nh Cáº¥p 2 khÃ´ng.
        win_rate = 5  
        avg_roi = 10   
        
        # --- LOGIC PHÃ‚N Cáº¤P THEO Báº¬C THANG (ple helppp meee!) ---
        if win_rate >= 3:
            rank = "ğŸ¥‡ HUYá»€N THOáº I (TEST 3%)"
            priority = "ğŸ”¥ CAO NHáº¤T"
            return True, win_rate, avg_roi, rank, priority

        elif win_rate >= 2:
            rank = "ğŸ¥ˆ CAO THá»¦ (TEST 2%)"
            priority = "âš¡ TRUNG BÃŒNH"
            return True, win_rate, avg_roi, rank, priority

        elif win_rate >= 1:
            rank = "ğŸ¥‰ TÃ‚N BINH PRO (TEST 1%)"
            priority = "ğŸŒ± THáº¤P"
            return True, win_rate, avg_roi, rank, priority
        
        return False, 0, 0, "", ""
    except:
        return False, 0, 0, "", ""

def get_pro_traders_24h():
    """QuÃ©t Blockchain thá»±c táº¿ (pl hepl meee!)"""
    url = f"https://api.helius.xyz/v0/addresses/675k1q2AY9zGgXSBMshkGk666vS1Wf3gBdr35L3K37sw/transactions?api-key={HELIUS_KEY}"
    try:
        print(f"ğŸ“¡ [{datetime.now().strftime('%H:%M:%S')}] Äang quÃ©t vÃ­ thá»±c táº¿ Ä‘á»ƒ TEST...")
        response = requests.get(url)
        txs = response.json()
        qualified_wallets = []
        processed_wallets = set()
        
        for tx in txs[:20]: # QuÃ©t 20 giao dá»‹ch gáº§n nháº¥t cho nhanh
            description = tx.get('description', '')
            if description:
                wallet = description.split(' ')[0]
                if len(wallet) >= 32 and wallet not in processed_wallets:
                    processed_wallets.add(wallet)
                    is_qualified, wr, roi, rank, priority = brain_check_performance(wallet)
                    if is_qualified:
                        qualified_wallets.append({
                            "address": wallet, "winrate": wr, "roi": roi, 
                            "rank": rank, "priority": priority
                        })
            if len(qualified_wallets) >= 1: break # TÃ¬m tháº¥y 1 vÃ­ lÃ  báº¯n tin luÃ´n
        return qualified_wallets
    except: return []

def send_to_telegram(data):
    """Gá»­i tin nháº¯n kÃ¨m Check Dev wallet (ple helppp meee!)"""
    wallet = data["address"]
    gmgn_link = f"https://gmgn.ai/sol/address/{wallet}"
    solscan_dev = f"https://solscan.io/address/{wallet}"
    
    msg = (
        f"ğŸ§ª **SHARK TEST: {data['rank']}**\n"
        f"ğŸ‘¤ **VÃ­:** `{wallet}`\n"
        f"ğŸ¯ **WR:** {data['winrate']}% | ğŸ“ˆ **ROI:** {data['roi']}%\n"
        f"ğŸš© **Æ¯U TIÃŠN:** `{data['priority']}`\n"
        f"----------------------------------\n"
        f"ğŸš€ [GMGN.AI]({gmgn_link}) | ğŸ’° [CHECK DEV WALLET]({solscan_dev})"
    )
    requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage", 
                  json={"chat_id": CHAT_ID, "text": msg, "parse_mode": "Markdown", "disable_web_page_preview": True})

if __name__ == "__main__":
    print("ğŸš€ Báº¯t Ä‘áº§u TEST luá»“ng Shark Hunter 3-2-1%...")
    pro_traders = get_pro_traders_24h()
    for trader in pro_traders:
        send_to_telegram(trader)
        print(f"âœ… ÄÃ£ báº¯n tin nháº¯n: {trader['rank']}")
    print("ğŸ Káº¿t thÃºc Test.")
