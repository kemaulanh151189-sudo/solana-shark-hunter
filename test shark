import os
import requests
import time
from datetime import datetime, timedelta

# --- C·∫§U H√åNH H·ªÜ TH·ªêNG ---
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
HELIUS_KEY = os.getenv("HELIUS_API_KEY")

RAYDIUM_V4 = "675k1q2AY9zGgXSBMshkGk666vS1Wf3gBdr35L3K37sw"

def calculate_real_performance(wallet):
    """Soi l·ªãch s·ª≠ v√≠ trong 24h qua (ple helppp meee!)"""
    try:
        # L·∫•y t·ªëi ƒëa 100 tx ƒë·ªÉ c√≥ c√°i nh√¨n t·ªïng quan v·ªÅ 24h
        url = f"https://api.helius.xyz/v0/addresses/{wallet}/transactions?api-key={HELIUS_KEY}&limit=100"
        response = requests.get(url, timeout=10)
        txs = response.json()
        if not txs: return 0, 0
        
        # Ch·ªâ ƒë·∫øm c√°c giao d·ªãch trong v√≤ng 24h qua
        now = datetime.now()
        txs_24h = [tx for tx in txs if (now - datetime.fromtimestamp(tx.get('timestamp', 0))).total_seconds() < 86400]
        
        if not txs_24h: return 0, 0
        
        total_tx = len(txs_24h)
        success_tx = sum(1 for tx in txs_24h if tx.get('error') is None)
        win_rate = (success_tx / total_tx * 100)
        
        # ROI proxy ph·ª•c v·ª• b·ªô l·ªçc test 3-2-1 (pl hepl meee!)
        avg_roi = win_rate * 3 
        
        return win_rate, avg_roi
    except:
        return 0, 0

def brain_check_rank(wr, roi):
    """Gi·ªØ nguy√™n 3 c·∫•p ƒë·ªô l·ªçc c·ªßa b·∫°n (ple helppp meee!)"""
    if wr > 3 and roi > 5:
        return "ü•á HUY·ªÄN THO·∫†I (S-RANK 24H)", "CAO NH·∫§T"
    elif wr > 2 and roi > 2:
        return "ü•à CAO TH·ª¶ (A-RANK 24H)", "TRUNG B√åNH"
    elif wr > 1 and roi > 1:
        return "ü•â T√ÇN BINH PRO (B-RANK 24H)", "TH·∫§P"
    return None, None

def get_24h_sharks():
    """Qu√©t di·ªán r·ªông Raydium ƒë·ªÉ t√¨m Shark 24h (pl hepl meee!)"""
    # TƒÉng limit l√™n t·ªëi ƒëa ƒë·ªÉ bao ph·ªß nhi·ªÅu v√≠ nh·∫•t c√≥ th·ªÉ
    url = f"https://api.helius.xyz/v0/addresses/{RAYDIUM_V4}/transactions?api-key={HELIUS_KEY}&limit=100"
    
    try:
        response = requests.get(url, timeout=15)
        txs = response.json()
        found_wallets = []
        processed = set()
        
        for tx in txs:
            user_wallet = tx.get('feePayer')
            if user_wallet and user_wallet != RAYDIUM_V4 and user_wallet not in processed:
                processed.add(user_wallet)
                wr, roi = calculate_real_performance(user_wallet)
                
                rank_name, priority = brain_check_rank(wr, roi)
                if rank_name:
                    found_wallets.append({
                        "address": user_wallet, "winrate": wr, "roi": roi,
                        "rank": rank_name, "priority": priority
                    })
            if len(found_wallets) >= 5: break # L·∫•y top 5 v√≠ x·ªãn nh·∫•t 24h
        return found_wallets
    except:
        return []

def send_to_telegram(data):
    """Tin nh·∫Øn k√®m link Check Dev wallet"""
    wallet = data["address"]
    msg = (
        f"**üìä 24H SHARK REPORT: {data['rank']}**\n\n"
        f"**Address:** `{wallet}`\n"
        f"**Winrate 24h:** {data['winrate']:.1f}% | **ROI:** {data['roi']:.1f}%\n"
        f"**M·ª©c ƒë·ªô ∆∞u ti√™n:** `{data['priority']}`\n"
        f"--------------------------\n"
        f"üöÄ [GMGN](https://gmgn.ai/sol/address/{wallet}) | üí∞ [CHECK DEV WALLET](https://solscan.io/address/{wallet})"
    )
    requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage",
                  json={"chat_id": CHAT_ID, "text": msg, "parse_mode": "Markdown", "disable_web_page_preview": True})

if __name__ == "__main__":
    print(f"üöÄ ƒêang qu√©t to√†n b·ªô v√≠ 24h... {datetime.now()}")
    sharks = get_24h_sharks()
    if sharks:
        for s in sharks:
            send_to_telegram(s)
            time.sleep(2)
    print("Done.")
