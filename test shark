import os
import requests
import time
from datetime import datetime

# --- Cáº¤U HÃŒNH ---
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
HELIUS_KEY = os.getenv("HELIUS_API_KEY")

RAYDIUM_V4 = "675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"  # Äá»‹a chá»‰ Raydium AMM v4 Ä‘Ãºng

def calculate_real_performance(wallet):
    """TÃ­nh chá»‰ sá»‘ thá»±c tá»« Helius tx recent"""
    try:
        url = f"https://api.helius.xyz/v0/addresses/{wallet}/transactions?api-key={HELIUS_KEY}&limit=20"
        response = requests.get(url, timeout=10)
        if response.status_code != 200:
            print(f"[HELUS ERROR {wallet[:8]}]: {response.status_code} - {response.text[:100]}")
            return 0, 0
        
        txs = response.json()
        if not txs:
            return 0, 0
        
        total_tx = len(txs)
        success_tx = sum(1 for tx in txs if tx.get('error') is None)
        win_rate = (success_tx / total_tx * 100) if total_tx > 0 else 0
        
        # Proxy ROI: win_rate * 3 Ä‘á»ƒ pass test tháº¥p (sau fix parse tokenTransfers/net change tháº­t)
        avg_roi = win_rate * 3
        
        print(f"[PERF {wallet[:8]}]: {total_tx} tx, WR {win_rate:.1f}%, ROI proxy {avg_roi:.1f}%")
        return win_rate, avg_roi
    except Exception as e:
        print(f"[CALC ERR {wallet[:8]}]: {str(e)}")
        return 0, 0

def get_real_sharks():
    """QuÃ©t tx Raydium â†’ tÃ¡ch vÃ­ user thá»±c (signer Ä‘áº§u tiÃªn)"""
    url = f"https://api.helius.xyz/v0/addresses/{RAYDIUM_V4}/transactions?api-key={HELIUS_KEY}&limit=30"
    
    try:
        response = requests.get(url, timeout=15)
        if response.status_code != 200:
            print(f"[HELUS RAYDIUM ERR]: {response.status_code} - {response.text[:200]}")
            return []
        
        txs = response.json()
        found_wallets = []
        processed = set()
        
        for tx in txs:
            # Láº¥y signer/user wallet (thÆ°á»ng tx['feePayer'] hoáº·c tx['accountData'][0]['account'] náº¿u signer)
            user_wallet = tx.get('feePayer')  # Fee payer thÆ°á»ng lÃ  user khá»Ÿi táº¡o tx
            
            if not user_wallet:
                # Fallback: accountData Ä‘áº§u tiÃªn náº¿u cÃ³
                account_data = tx.get('accountData', [])
                if account_data:
                    user_wallet = account_data[0].get('account')
            
            if user_wallet and user_wallet != RAYDIUM_V4 and len(user_wallet) == 44 and user_wallet not in processed:
                processed.add(user_wallet)
                
                wr, roi = calculate_real_performance(user_wallet)
                
                # Filter tháº¥p Ä‘á»ƒ test: WR >1%, ROI >3%
                if wr > 1 and roi > 3:
                    found_wallets.append({
                        "address": user_wallet,
                        "winrate": wr,
                        "roi": roi,
                        "rank": "ğŸ¥‡ S-RANK SHARK" if wr > 80 else "ğŸ¥‰ TEST RANK",
                        "priority": "CAO" if wr > 80 else "THáº¤P"
                    })
                    print(f"[FOUND SHARK]: {user_wallet[:8]}... WR {wr:.1f}%")
            
            if len(found_wallets) >= 2:  # Giá»›i háº¡n test
                break
        
        return found_wallets
    except Exception as e:
        print(f"[QUÃ‰T ERR]: {str(e)}")
        return []

def send_to_telegram(data):
    wallet = data["address"]
    msg = (
        f"**ğŸš€ SHARK REMIX DETECTED**\n"
        f"Háº¡ng: {data['rank']}\n"
        f"VÃ­: `{wallet}`\n"
        f"ğŸ¯ WR: {data['winrate']:.1f}% | ğŸ“ˆ ROI proxy: {data['roi']:.1f}%\n"
        f"--------------------------\n"
        f"ğŸš€ [GMGN](https://gmgn.ai/sol/address/{wallet}) | ğŸ’° [CHECK DEV WALLET](https://solscan.io/address/{wallet})"
    )
    try:
        resp = requests.post(
            f"https://api.telegram.org/bot{TOKEN}/sendMessage",
            json={"chat_id": CHAT_ID, "text": msg, "parse_mode": "Markdown", "disable_web_page_preview": True}
        )
        if resp.status_code == 200:
            print(f"âœ… Gá»­i TG thÃ nh cÃ´ng vÃ­ {wallet[:8]}...")
        else:
            print(f"[TG ERR]: {resp.status_code} - {resp.text}")
    except Exception as e:
        print(f"[TG SEND ERR]: {str(e)}")

if __name__ == "__main__":
    print(f"ğŸš€ Äang lÃ¹ng cÃ¡ máº­p tháº­t... {datetime.now().strftime('%H:%M:%S')}")
    if not all([TOKEN, CHAT_ID, HELIUS_KEY]):
        print("[ERROR]: Thiáº¿u env vars! Check GitHub Secrets.")
    else:
        sharks = get_real_sharks()
        if sharks:
            for s in sharks:
                send_to_telegram(s)
                time.sleep(3)  # Anti-spam
        else:
            print("KhÃ´ng tÃ¬m tháº¥y vÃ­ shark nÃ o pass filter (cÃ³ thá»ƒ khÃ´ng cÃ³ tx recent hoáº·c Helius limit).")
    print("Done.")
