import os
import requests
import time
from datetime import datetime, timezone

# --- Cáº¤U HÃŒNH TEST (ple helppp meee!) ---
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
HELIUS_KEY = os.getenv("HELIUS_API_KEY")

def brain_test_shark(wallet):
    """NÃƒO Bá»˜ TEST: Háº¡ tiÃªu chuáº©n Ä‘á»ƒ cháº¯c cháº¯n cÃ³ vÃ­ Ä‘Æ°á»£c chá»n (pl hepl meee!)"""
    try:
        # GIáº¢ Láº¬P: Chá»‰ sá»‘ ráº¥t tháº¥p Ä‘á»ƒ dá»… dÃ ng vÆ°á»£t qua bÃ i test
        win_rate = 15  # Chá»‰ cáº§n > 10% lÃ  Ä‘áº¡t
        avg_roi = 20   # Chá»‰ cáº§n > 10% lÃ  Ä‘áº¡t
        token_diversity = 2 # Chá»‰ cáº§n trade 2 con lÃ  Ä‘áº¡t

        # ÄIá»€U KIá»†N TEST Cá»°C THáº¤P
        if win_rate >= 10 and avg_roi >= 10:
            rank = "ğŸ§ª TEST SHARK (LEVEL 0)"
            print(f"âœ… [TEST PASS]: VÃ­ {wallet[:8]}... Ä‘Ã£ vÆ°á»£t qua bá»™ lá»c tá»‘i thiá»ƒu.")
            return True, win_rate, avg_roi, rank
        
        return False, 0, 0, ""
    except:
        return False, 0, 0, ""

def get_test_traders():
    """QuÃ©t nhanh vÃ i giao dá»‹ch Ä‘á»ƒ test (ple helppp meee!)"""
    # DÃ¹ng Raydium Authority Ä‘á»ƒ láº¥y giao dá»‹ch thá»±c
    url = f"https://api.helius.xyz/v0/addresses/675k1q2AY9zGgXSBMshkGk666vS1Wf3gBdr35L3K37sw/transactions?api-key={HELIUS_KEY}"
    
    try:
        print(f"ğŸ“¡ [{datetime.now().strftime('%H:%M:%S')}] Äang cháº¡y cháº¿ Ä‘á»™ TEST...")
        response = requests.get(url)
        txs = response.json()
        
        # Chá»‰ láº¥y 5 vÃ­ má»›i nháº¥t Ä‘á»ƒ test cho nhanh
        test_wallets = []
        processed = set()
        
        for tx in txs[:50]: # QuÃ©t rá»™ng má»™t chÃºt Ä‘á»ƒ tÃ¬m vÃ­
            description = tx.get('description', '')
            if description:
                wallet = description.split(' ')[0]
                if len(wallet) >= 32 and wallet not in processed:
                    processed.add(wallet)
                    is_ok, wr, roi, rank = brain_test_shark(wallet)
                    if is_ok:
                        test_wallets.append({"address": wallet, "wr": wr, "roi": roi, "rank": rank})
            if len(test_wallets) >= 2: break # TÃ¬m tháº¥y 2 vÃ­ lÃ  dá»«ng test ngay
            
        return test_wallets
    except Exception as e:
        print(f"ğŸš¨ Error: {e}")
        return []

def send_test_msg(data):
    """Gá»­i tin nháº¯n test lÃªn Telegram (pl hepl meee!)"""
    msg = (
        f"ğŸ§ª **TEST MODE ACTIVE**\n"
        f"ğŸ‘¤ **VÃ­:** `{data['address']}`\n"
        f"ğŸ“Š **Rank:** {data['rank']}\n"
        f"----------------------------------\n"
        f"ğŸ’° [CHECK DEV WALLET](https://solscan.io/address/{data['address']})"
    )
    requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage", 
                  json={"chat_id": CHAT_ID, "text": msg, "parse_mode": "Markdown"})
    print(f"ğŸ“¤ ÄÃ£ gá»­i tin nháº¯n test cho vÃ­ {data['address'][:8]}...")

if __name__ == "__main__":
    print("ğŸš€ Báº¯t Ä‘áº§u test luá»“ng Shark Hunter...")
    results = get_test_traders()
    for item in results:
        send_test_msg(item)
    print("ğŸ Káº¿t thÃºc Test.")
