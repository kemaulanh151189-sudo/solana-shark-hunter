import os
import requests
import time
from datetime import datetime

# --- Cáº¤U HÃŒNH Há»† THá»NG (pl hepl meee!) ---
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
HELIUS_KEY = os.getenv("HELIUS_API_KEY")

# Danh sÃ¡ch vÃ­ sÃ n/há»‡ thá»‘ng cáº§n loáº¡i bá» (Blacklist)
SYSTEM_WALLETS = [
    "675k1q2AY9zGgXSBMshkGk666vS1Wf3gBdr35L3K37sw", # Raydium Authority V4
    "5Q544fKrSJu7L6m66iS15zC1XNmD9X7NUnQhE2wU9z6N", # Raydium Stake
    "TSLpA2Lc3WfB24Uoe7FW8sh3pkfC3Tf7BAb7L13n52z"  # VÃ­ há»‡ thá»‘ng khÃ¡c
]

def brain_check_shark(wallet_data):
    """
    NÃƒO Bá»˜ PHÃ‚N Cáº¤P: XÃ o láº¡i tá»« cÃ¡c tiÃªu chuáº©n sÄƒn Whale GitHub (ple helppp meee!)
    """
    wr = wallet_data.get('win_rate', 0)
    roi = wallet_data.get('roi', 0)
    
    # Cáº¥p 1: HUYá»€N THOáº I (Dá»±a trÃªn thÃ´ng sá»‘ báº¡n muá»‘n test)
    if wr >= 3:
        return True, "ğŸ¥‡ HUYá»€N THOáº I", "ğŸ”¥ CAO NHáº¤T"
    # Cáº¥p 2: CAO THá»¦
    elif wr >= 2:
        return True, "ğŸ¥ˆ CAO THá»¦", "âš¡ TRUNG BÃŒNH"
    # Cáº¥p 3: TÃ‚N BINH
    elif wr >= 1:
        return True, "ğŸ¥‰ TÃ‚N BINH PRO", "ğŸŒ± THáº¤P"
    
    return False, "", ""

def get_real_traders():
    """QuÃ©t blockchain vÃ  lá»c bá» vÃ­ sÃ n (pl hepl meee!)"""
    url = f"https://api.helius.xyz/v0/addresses/675k1q2AY9zGgXSBMshkGk666vS1Wf3gBdr35L3K37sw/transactions?api-key={HELIUS_KEY}"
    try:
        response = requests.get(url)
        txs = response.json()
        found_sharks = []
        
        for tx in txs:
            description = tx.get('description', '')
            if not description: continue
            
            # Láº¥y vÃ­ ngÆ°á»i thá»±c hiá»‡n giao dá»‹ch
            potential_shark = description.split(' ')[0]
            
            # CHáº¶N VÃ SÃ€N: Náº¿u lÃ  vÃ­ há»‡ thá»‘ng thÃ¬ bá» qua ngay
            if potential_shark in SYSTEM_WALLETS or len(potential_shark) < 32:
                continue
            
            # Giáº£ láº­p check chá»‰ sá»‘ (Trong thá»±c táº¿ báº¡n sáº½ gá»i API Birdeye/DexScreener á»Ÿ Ä‘Ã¢y)
            # á» Ä‘Ã¢y mÃ¬nh giá»¯ nguyÃªn má»©c háº¡ chuáº©n 3-2-1% Ä‘á»ƒ báº¡n tháº¥y nÃ³ bÃ¡o vá» liÃªn tá»¥c
            mock_data = {'win_rate': 5, 'roi': 150} 
            
            is_qualified, rank, priority = brain_check_shark(mock_data)
            if is_qualified:
                found_sharks.append({
                    "address": potential_shark,
                    "rank": rank,
                    "priority": priority,
                    "wr": mock_data['win_rate'],
                    "roi": mock_data['roi']
                })
                if len(found_sharks) >= 1: break # TÃ¬m tháº¥y 1 con cÃ¡ tháº­t lÃ  bÃ¡o ngay
        return found_sharks
    except Exception as e:
        print(f"Lá»—i quÃ©t: {e}")
        return []

def send_shark_alert(shark):
    """Gá»­i tin nháº¯n chuáº©n máº«u báº¡n Ä‘Ã£ duyá»‡t"""
    solscan_dev = f"https://solscan.io/address/{shark['address']}"
    gmgn_link = f"https://gmgn.ai/sol/address/{shark['address']}"
    
    msg = (
        f"ğŸ¯ **SHARK DETECTED**\n"
        f"ğŸ“Š Háº¡ng: {shark['rank']}\n"
        f"ğŸ‘¤ VÃ­: `{shark['address']}`\n"
        f"ğŸ¯ WR: {shark['wr']}% | ğŸ“ˆ ROI: {shark['roi']}%\n"
        f"ğŸš© Æ¯U TIÃŠN: `{shark['priority']}`\n"
        f"----------------------------------\n"
        f"ğŸš€ [GMGN.AI]({gmgn_link}) | ğŸ’° [CHECK DEV WALLET]({solscan_dev})"
    )
    requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage", 
                  json={"chat_id": CHAT_ID, "text": msg, "parse_mode": "Markdown", "disable_web_page_preview": True})

if __name__ == "__main__":
    print("ğŸš€ Shark Hunter Pro Ä‘ang rÃ¬nh má»“i...")
    sharks = get_real_traders()
    for s in sharks:
        send_shark_alert(s)
        print(f"âœ… ÄÃ£ bÃ¡o cÃ¡o cÃ¡ máº­p: {s['address'][:8]}")
