import os
import requests
import time
from datetime import datetime, timedelta

# --- C·∫§U H√åNH H·ªÜ TH·ªêNG ---
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
HELIUS_KEY = os.getenv("HELIUS_API_KEY")

# S·ª≠a ƒë·ªãa ch·ªâ Raydium AMM v4 ƒë√∫ng (Legacy Constant Product) t·ª´ docs Raydium
RAYDIUM_V4 = "675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"

def get_all_tx_24h(address, is_raydium=False):
    """Qu√©t l√πi th·ªùi gian ƒë·ªÉ l·∫•y T·∫§T C·∫¢ giao d·ªãch trong 24h (ple helppp meee!)"""
    all_txs = []
    last_signature = None
    cutoff_time = datetime.now() - timedelta(hours=24)
    
    # Helius cho ph√©p paginate b·∫±ng 'before' (signature tr∆∞·ªõc ƒë√≥)
    for _ in range(15):  # T·ªëi ƒëa 15 trang (1500 tx, ƒë·ªß cho 24h)
        url = f"https://api.helius.xyz/v0/addresses/{address}/transactions?api-key={HELIUS_KEY}&limit=100"
        if last_signature:
            url += f"&before={last_signature}"
        
        try:
            response = requests.get(url, timeout=10)
            response.raise_for_status()  # Raise n·∫øu l·ªói HTTP
            txs = response.json()
            if not txs:
                break
            
            added = False
            for tx in txs:
                ts = tx.get('timestamp')
                if ts and datetime.fromtimestamp(ts) >= cutoff_time:
                    all_txs.append(tx)
                    added = True
                else:
                    # ƒê√£ qu√° 24h ‚Üí d·ª´ng
                    return all_txs
            
            if not added:
                break  # Kh√¥ng c√≤n tx trong 24h
            
            last_signature = txs[-1].get('signature')
            if not last_signature:
                break
            time.sleep(0.2)  # Anti-rate limit nh·∫π
        except Exception as e:
            print(f"[L·ªñI PAGINATE {address[:8]}...]: {str(e)}")
            break
    
    return all_txs

def calculate_win_token_percent(wallet):
    """T√≠nh t·ªïng s·ªë % Token chi·∫øn th·∫Øng trong 24h (ple helppp meee!)"""
    txs_24h = get_all_tx_24h(wallet)
    if not txs_24h:
        return 0, 0
    
    total_tx = len(txs_24h)
    # L·ªçc giao d·ªãch th√†nh c√¥ng (kh√¥ng error)
    success_tx = sum(1 for tx in txs_24h if tx.get('error') is None)
    
    # % th·∫Øng = success / total (proxy cho % token win, v√¨ m·ªói tx swap th∆∞·ªùng li√™n quan token)
    win_token_percent = (success_tx / total_tx * 100) if total_tx > 0 else 0
    
    return win_token_percent, total_tx

def hunt_top_10():
    """Tuy·ªÉn ch·ªçn 10 v√≠ c√≥ % th·∫Øng cao nh·∫•t 24h (pl hepl meee!)"""
    print(f"üöÄ ƒêang qu√©t to√†n b·ªô Raydium 24h...")
    
    # L·∫•y tx Raydium ƒë·ªÉ extract potential wallets (feePayer = user)
    raydium_txs = get_all_tx_24h(RAYDIUM_V4, is_raydium=True)
    potential_wallets = set()
    for tx in raydium_txs:
        w = tx.get('feePayer')
        if w and w != RAYDIUM_V4:
            potential_wallets.add(w)
    
    print(f"üîç ƒêang ph√¢n t√≠ch {len(potential_wallets)} v√≠...")
    leaderboard = []
    
    for wallet in potential_wallets:
        win_percent, total_count = calculate_win_token_percent(wallet)
        
        # ƒê∆∞a v√†o m√°y ch√©m ph√¢n lo·∫°i 3 c·∫•p ƒë·ªô (pl hepl meee!)
        rank = None
        if win_percent > 80:
            rank = "ü•á S-RANK (SI√äU C√Å M·∫¨P)"
        elif win_percent > 50:
            rank = "ü•à A-RANK (CAO TH·ª¶)"
        elif win_percent > 20:
            rank = "ü•â B-RANK (TI·ªÄM NƒÇNG)"
        
        if rank:
            leaderboard.append({
                "address": wallet,
                "win_pct": win_percent,
                "total": total_count,
                "rank": rank
            })
            print(f"[FOUND]: {wallet[:8]}... {rank} - {win_percent:.1f}%")
    
    # S·∫Øp x·∫øp v√† l·∫•y 10 v√≠ t·ªët nh·∫•t theo % th·∫Øng
    leaderboard.sort(key=lambda x: x['win_pct'], reverse=True)
    top_10 = leaderboard[:10]
    print(f"Top 10: {len(top_10)} v√≠ ƒë·∫°t chu·∫©n.")
    return top_10

def send_to_telegram(data, index):
    """G·ª≠i tin nh·∫Øn chu·∫©n k√®m link Check Dev wallet"""
    wallet = data["address"]
    gmgn = f"https://gmgn.ai/sol/address/{wallet}"
    solscan = f"https://solscan.io/address/{wallet}"
    
    msg = (
        f"**üèÜ TOP {index+1} SHARK 24H**\n"
        f"C·∫•p ƒë·ªô: `{data['rank']}`\n"
        f"V√≠: `{wallet}`\n"
        f"üî• **T·ªïng % Token th·∫Øng: {data['win_pct']:.1f}%**\n"
        f"üì¶ T·ªïng giao d·ªãch 24h: {data['total']}\n"
        f"--------------------------\n"
        f"üöÄ [GMGN]({gmgn}) | üí∞ [CHECK DEV WALLET]({solscan})"
    )
    try:
        resp = requests.post(
            f"https://api.telegram.org/bot{TOKEN}/sendMessage",
            json={"chat_id": CHAT_ID, "text": msg, "parse_mode": "Markdown", "disable_web_page_preview": True}
        )
        if resp.status_code == 200:
            print(f"[TG OK] TOP {index+1}: {wallet[:8]}...")
        else:
            print(f"[TG ERR]: {resp.status_code} - {resp.text[:100]}")
    except Exception as e:
        print(f"[TG SEND ERR]: {str(e)}")

if __name__ == "__main__":
    print(f"=== START QU√âT TOP SHARK 24H: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} ===")
    if not all([TOKEN, CHAT_ID, HELIUS_KEY]):
        print("[ERROR]: Thi·∫øu env vars! Ki·ªÉm tra GitHub Secrets.")
    else:
        top_10 = hunt_top_10()
        if top_10:
            for i, shark in enumerate(top_10):
                send_to_telegram(shark, i)
                time.sleep(3)  # Anti-spam Telegram
        else:
            print("Kh√¥ng v√≠ n√†o ƒë·∫°t chu·∫©n (c√≥ th·ªÉ rate limit Helius ho·∫∑c √≠t tx).")
    print("=== DONE ===")
