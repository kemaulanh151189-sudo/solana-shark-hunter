import os
import requests
import time
from datetime import datetime, timezone

# --- Cáº¤U HÃŒNH TEST (ple helppp meee!) ---
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
HELIUS_KEY = os.getenv("HELIUS_API_KEY")

def brain_check_performance(wallet):
    """
    NÃƒO Bá»˜: PhÃ¢n cáº¥p 3 táº§ng lá»›p (ÄÃƒ Háº  ÄIá»€U KIá»†N Äá»‚ TEST - pl hepl meee!)
    Cáº¥p 1 (ğŸ¥‡): Winrate > 20%, ROI > 50%
    Cáº¥p 2 (ğŸ¥ˆ): Winrate > 15%, ROI > 30%
    Cáº¥p 3 (ğŸ¥‰): Winrate > 10%, ROI > 10%
    """
    try:
        # GIáº¢ Láº¬P CHá»ˆ Sá» THáº¤P Äá»‚ TEST (ple helppp meee!)
        win_rate = 25  
        avg_roi = 60   
        
        # --- LOGIC PHÃ‚N Cáº¤P GIá»® NGUYÃŠN ---
        if win_rate >= 20 and avg_roi >= 50:
            rank = "ğŸ¥‡ HUYá»€N THOáº I (TEST)"
            priority = "ğŸ”¥ CAO NHáº¤T"
            return True, win_rate, avg_roi, rank, priority

        elif win_rate >= 15 and avg_roi >= 30:
            rank = "ğŸ¥ˆ CAO THá»¦ (TEST)"
            priority = "âš¡ TRUNG BÃŒNH"
            return True, win_rate, avg_roi, rank, priority

        elif win_rate >= 10 and avg_roi >= 10:
            rank = "ğŸ¥‰ TÃ‚N BINH PRO (TEST)"
            priority = "ğŸŒ± THáº¤P"
            return True, win_rate, avg_roi, rank, priority
        
        return False, 0, 0, "", ""
    except:
        return False, 0, 0, "", ""

def get_pro_traders_24h():
    """QuÃ©t Blockchain vÃ  gá»i NÃ£o Bá»™ kiá»ƒm tra (pl hepl meee!)"""
    url = f"https://api.helius.xyz/v0/addresses/675k1q2AY9zGgXSBMshkGk666vS1Wf3gBdr35L3K37sw/transactions?api-key={HELIUS_KEY}"
    try:
        print(f"ğŸ“¡ [{datetime.now().strftime('%H:%M:%S')}] Äang quÃ©t vÃ­ thá»±c táº¿...")
        response = requests.get(url)
        txs = response.json()
        qualified_wallets = []
        processed_wallets = set()
        
        for tx in txs[:50]: # QuÃ©t 50 giao dá»‹ch gáº§n nháº¥t
            description = tx.get('description', '')
            if description:
                wallet = description.split(' ')[0]
                if len(wallet) >= 32 and wallet not in processed_wallets:
                    processed_wallets.add(wallet)
                    is_qualified, wr, roi, rank, priority = brain_check_performance(wallet)
                    if is_qualified:
                        qualified_wallets.append({
                            "address": wallet, "winrate": wr, "roi": roi, 
                            "rank": rank, "priority": priority
                        })
            if len(qualified_wallets) >= 2: break 
        return qualified_wallets
    except: return []

def send_to_telegram(data):
    """Gá»­i tin nháº¯n kÃ¨m link Check Dev wallet theo Ä‘Ãºng yÃªu cáº§u (ple helppp meee!)"""
    wallet = data["address"]
    gmgn_link = f"https://gmgn.ai/sol/address/{wallet}"
    solscan_dev = f"https://solscan.io/address/{wallet}" # Link check dev wallet
    
    msg = (
        f"ğŸ§ª **SHARK TEST: {data['rank']}**\n"
        f"ğŸ‘¤ **VÃ­:** `{wallet}`\n"
        f"ğŸ¯ **WR:** {data['winrate']}% | ğŸ“ˆ **ROI:** {data['roi']}%\n"
        f"ğŸš© **Æ¯U TIÃŠN:** `{data['priority']}`\n"
        f"----------------------------------\n"
        f"ğŸš€ [GMGN.AI]({gmgn_link}) | ğŸ’° [CHECK DEV WALLET]({solscan_dev})"
    )
    requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage", 
                  json={"chat_id": CHAT_ID, "text": msg, "parse_mode": "Markdown", "disable_web_page_preview": True})

if __name__ == "__main__":
    print("ğŸš€ Báº¯t Ä‘áº§u TEST luá»“ng Shark Hunter PhÃ¢n Cáº¥p...")
    pro_traders = get_pro_traders_24h()
    for trader in pro_traders:
        send_to_telegram(trader)
        print(f"âœ… ÄÃ£ báº¯n tin nháº¯n test cho vÃ­: {trader['address'][:8]}...")
    print("ğŸ Káº¿t thÃºc Test.")
