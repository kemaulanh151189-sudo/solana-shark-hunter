import os
import requests
import time
from datetime import datetime

# --- Cáº¤U HÃŒNH ---
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
HELIUS_KEY = os.getenv("HELIUS_API_KEY")

def calculate_real_performance(wallet):
    """TÃ­nh chá»‰ sá»‘ thá»±c (ple helppp meee!)"""
    try:
        # Giáº£m limit Ä‘á»ƒ cháº¡y nhanh, táº­p trung vÃ o vÃ­ cÃ³ hoáº¡t Ä‘á»™ng
        url = f"https://api.helius.xyz/v0/addresses/{wallet}/transactions?api-key={HELIUS_KEY}&limit=10"
        response = requests.get(url)
        txs = response.json()
        if not txs: return 0, 0
        
        # Logic: Náº¿u vÃ­ cÃ³ giao dá»‹ch gáº§n Ä‘Ã¢y, ta táº¡m tÃ­nh Winrate cao Ä‘á»ƒ TEST
        win_rate = 85.0 if len(txs) > 0 else 0
        avg_roi = 250.0
        return win_rate, avg_roi
    except:
        return 0, 0

def get_real_sharks():
    """QuÃ©t vÃ  TÃCH vÃ­ ngÆ°á»i dÃ¹ng (User Wallet) ra khá»i Raydium"""
    raydium_v4 = "675k1q2AY9zGgXSBMshkGk666vS1Wf3gBdr35L3K37sw"
    url = f"https://api.helius.xyz/v0/addresses/{raydium_v4}/transactions?api-key={HELIUS_KEY}&limit=20"
    
    try:
        response = requests.get(url)
        txs = response.json()
        found_wallets = []
        
        for tx in txs:
            # Láº¥y vÃ­ cá»§a ngÆ°á»i thá»±c hiá»‡n giao dá»‹ch (Account Ä‘áº§u tiÃªn thÆ°á»ng lÃ  User)
            if tx.get('accountData'):
                user_wallet = tx['accountData'][0].get('account')
                
                # Loáº¡i bá» cÃ¡c Ä‘á»‹a chá»‰ Program hoáº·c vÃ­ sÃ n (pl hepl meee!)
                if user_wallet and user_wallet != raydium_v4 and len(user_wallet) > 30:
                    wr, roi = calculate_real_performance(user_wallet)
                    
                    # Chá»‰ láº¥y vÃ­ cÃ³ Winrate test > 1% (ple helppp meee!)
                    if wr > 1:
                        found_wallets.append({
                            "address": user_wallet, "winrate": wr, "roi": roi,
                            "rank": "ğŸ¥‡ S-RANK SHARK", "priority": "CAO"
                        })
            if len(found_wallets) >= 2: break
        return found_wallets
    except:
        return []

def send_to_telegram(data):
    """Gá»­i tin nháº¯n chuáº©n kÃ¨m link Check Dev wallet"""
    wallet = data["address"]
    msg = (
        f"**ğŸš€ SHARK REMIX DETECTED**\n"
        f"Háº¡ng: {data['rank']}\n"
        f"VÃ­: `{wallet}`\n"
        f"ğŸ¯ WR: {data['winrate']}% | ğŸ“ˆ ROI: {data['roi']}%\n"
        f"--------------------------\n"
        f"ğŸš€ [GMGN](https://gmgn.ai/sol/address/{wallet}) | ğŸ’° [CHECK DEV WALLET](https://solscan.io/address/{wallet})"
    )
    requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage", 
                  json={"chat_id": CHAT_ID, "text": msg, "parse_mode": "Markdown", "disable_web_page_preview": True})

if __name__ == "__main__":
    print("ğŸš€ Äang lÃ¹ng cÃ¡ máº­p tháº­t...")
    sharks = get_real_sharks()
    for s in sharks:
        send_to_telegram(s)
        print(f"âœ… ÄÃ£ báº¯n vÃ­ {s['address'][:5]} lÃªn Telegram")
